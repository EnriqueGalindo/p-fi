{% extends "base.html" %}
{% block content %}
<style>
  .dash {border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0}
  .dash h2{margin:.2rem 0 1rem}
  .dash .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}
  .muted{color:#6b7280}
  .mini-table{width:100%;border-collapse:collapse}
  .mini-table th,.mini-table td{border-bottom:1px solid #f1f5f9;padding:.35rem .25rem;text-align:left}
  .pill{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:.25rem .6rem;text-decoration:none}
  .barwrap{height:8px;background:#f3f4f6;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:#111827}
  .good{color:#065f46} .bad{color:#7f1d1d}
  .flex{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid #e5e7eb;background:#fff;border-radius:8px;padding:.4rem .7rem;cursor:pointer}
  .btn:focus{outline:none}
  input[type=date]{border:1px solid #e5e7eb;border-radius:8px;padding:.35rem .5rem}
  @media (max-width: 900px){ .dash .grid{grid-template-columns:1fr} }
</style>

<div class="card">
  <h1>Ledger</h1>
  <p class="flex">
    <a href="{{ url_for('ledger.new_entry_form') }}" class="pill">+ Add entry</a>
    <a href="{{ url_for('ledger.history') }}" class="pill">History / Revert</a>
    <a href="{{ url_for('ledger_upload.upload_form') }}" class="pill">Upload</a>
  </p>

  <!-- Window selector (replaces week/month/year toggles) -->
  <form method="get" action="{{ url_for('ledger.list_entries') }}" class="dash" style="display:flex;gap:.75rem;align-items:flex-end;flex-wrap:wrap">
    <div>
      <label class="muted" for="start">Start</label><br>
      <input id="start" name="start" type="date" value="{{ (start or '')[:10] }}">
    </div>
    <div>
      <label class="muted" for="end">End</label><br>
      <input id="end" name="end" type="date" value="{{ (end or '')[:10] }}">
    </div>
    <div>
      <button class="btn" type="submit">Apply</button>
      <a class="pill" href="{{ url_for('ledger.list_entries') }}" title="Reset to current month">This month</a>
    </div>
    <div class="muted" style="margin-left:auto">
      Window: {{ (start or '')[:10] }} â†’ {{ (end or '')[:10] }}
    </div>
  </form>

  <!-- BUDGET COMPARISON: Actual vs Expected (from weekly budget prorated for window) -->
  <div class="dash">
    <h2>Actual vs Expected (expenses only)</h2>
    <div class="muted" style="margin-bottom:.5rem">
      Expected is derived from your weekly budget, prorated for {{ budget.days }} day{{ 's' if budget.days != 1 else '' }}.
    </div>
    <div class="grid">
      <!-- Totals card -->
      <div>
        <div style="font-weight:700;margin-bottom:.3rem">Totals</div>
        <table class="mini-table">
          <tbody>
            <tr><td>Actual</td><td style="text-align:right">${{ '%.2f'|format(budget.totals.actual) }}</td></tr>
            <tr><td>Expected</td><td style="text-align:right">${{ '%.2f'|format(budget.totals.expected) }}</td></tr>
            <tr>
              <td>Delta</td>
              <td style="text-align:right">
                {% set d = budget.totals.delta %}
                <span class="{{ 'bad' if d>0 else 'good' if d<0 else '' }}">
                  {{ '+' if d>0 else '' }}${{ '%.2f'|format(d) }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Per-category table -->
      <div style="grid-column:span 2;">
        <table class="mini-table">
          <thead>
            <tr>
              <th>Category</th>
              <th style="text-align:right">Actual</th>
              <th style="text-align:right">Expected</th>
              <th style="text-align:right">Î”</th>
            </tr>
          </thead>
          <tbody>
            {% for row in budget.rows %}
              {% set d = row.delta %}
              <tr>
                <td>{{ row.category }}</td>
                <td style="text-align:right">${{ '%.2f'|format(row.actual) }}</td>
                <td style="text-align:right">${{ '%.2f'|format(row.expected) }}</td>
                <td style="text-align:right">
                  <span class="{{ 'bad' if d>0 else 'good' if d<0 else '' }}">
                    {{ '+' if d>0 else '' }}${{ '%.2f'|format(d) }}
                  </span>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="muted">No categories in this window.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Your existing dashboard (still useful) -->
  <div class="dash">
    <div class="grid">
      <!-- Money In -->
      <div>
        <h2>Money in</h2>
        <div style="font-size:1.4rem;font-weight:700;">
          ${{ '%.2f'|format(stats.totals.income or 0) }}
        </div>
      </div>

      <!-- Expenses (total + by category) -->
      <div>
        <h2>Expenses</h2>
        <div style="font-size:1.1rem;font-weight:600;margin-bottom:.3rem;">
          Total: ${{ '%.2f'|format(stats.totals.expenses or 0) }}
        </div>
        <table class="mini-table">
          <thead><tr><th>Category</th><th style="text-align:right;">Amount</th></tr></thead>
          <tbody>
            {% for cat, amt in (stats.totals.expenses_by_category or {}).items()|sort %}
              <tr>
                <td>{{ cat }}</td>
                <td style="text-align:right;">${{ '%.2f'|format(amt or 0) }}</td>
              </tr>
            {% else %}
              <tr><td colspan="2" class="muted">No expenses in this window.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Debt payments + impacted debts -->
      <div>
        <h2>Debt payments</h2>
        <div style="font-size:1.1rem;font-weight:600;margin-bottom:.3rem;">
          Total to debt: ${{ '%.2f'|format(stats.totals.debt_paid or 0) }}
        </div>
        <table class="mini-table">
          <thead>
            <tr>
              <th>Debt</th>
              <th style="text-align:right;">Paid</th>
            </tr>
          </thead>
          <tbody>
          {% for d in stats.debts_impacted %}
            <tr>
              <td>
                <div style="font-weight:600">{{ d.name or 'â€”' }}</div>
                <div class="muted" style="font-size:.85rem;">
                  {{ d.first_ts }} â†’ {{ d.last_ts }}
                </div>
                {% if d.balance_before is not none and d.balance_after is not none %}
                  <div class="muted" style="font-size:.85rem;">
                    ${{ '%.2f'|format(d.balance_before) }} â†’ ${{ '%.2f'|format(d.balance_after) }}
                  </div>
                {% endif %}
              </td>
              <td style="text-align:right;">${{ '%.2f'|format(d.total_paid or 0) }}</td>
            </tr>
          {% else %}
            <tr><td colspan="2" class="muted">No debt payments in this window.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <p><a href="{{ url_for('ledger.new_entry_form') }}" class="pill">+ Add entry</a></p>

  <!-- Entries table -->
  <table>
    <thead>
      <tr>
        <th>When</th>
        <th>Type</th>
        <th>Amount</th>
        <th>From</th>
        <th>To / Debt</th>
        <th>Category</th>
        <th>Balance</th>
        <th>Note</th>
        <th style="width:48px; text-align:right;">&nbsp;</th>
      </tr>
    </thead>
    <tbody>
    {% for t in ledger %}
      <tr>
        <td class="muted">{{ t.ts }}</td>
        <td>{{ t.kind }}</td>
        <td>${{ '%.2f'|format(t.amount or 0) }}</td>
        <td>{{ t.from_account or 'â€”' }}</td>
        <td>{{ t.to_account or t.debt_name or 'â€”' }}</td>
        <td>{{ t.category or 'â€”' }}</td>

        <td>
          {% if t.balance_kind == 'account' %}
            {{ t.balance_name }}: ${{ '%.2f'|format(t.balance_after or 0) }}
          {% elif t.balance_kind == 'debt' %}
            {{ t.balance_name }}: ${{ '%.2f'|format(t.balance_after or 0) }}
          {% elif t.balance_kind == 'transfer' %}
            {{ t.balance_name_from }}: ${{ '%.2f'|format(t.balance_after_from or 0) }}
            â†’ {{ t.balance_name_to }}: ${{ '%.2f'|format(t.balance_after_to or 0) }}
          {% else %}
            â€”
          {% endif %}
        </td>

        <td>{{ t.note or '' }}</td>

        <td style="text-align:right;">
          {% if t.id %}
          <form method="post"
                action="{{ url_for('ledger.delete_entry', entry_id=t.id) }}"
                onsubmit="return confirm('Delete this entry? This will update balances.');"
                style="display:inline;">
            <button type="submit"
                    title="Delete"
                    class="btn">ðŸ—‘</button>
          </form>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% extends "base_rental.html" %}
{% block content %}
<div class="card" style="max-width:900px;">
  <h1 style="margin-top:0;">Edit Tenant</h1>

  <!-- ========================= -->
  <!-- Tenant Info Form -->
  <!-- ========================= -->
  <form method="POST" enctype="multipart/form-data" style="display:grid; gap:.75rem;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>First Name</label><br>
        <input name="first_name" value="{{ tenant.first_name }}" required>
      </div>
      <div>
        <label>Last Name</label><br>
        <input name="last_name" value="{{ tenant.last_name }}" required>
      </div>
    </div>

    <div>
      <label>Property</label><br>
      <select name="property_id" required>
        {% for pid, p in properties.items() %}
          <option value="{{ pid }}" {{ "selected" if tenant.property_id==pid else "" }}>
            {{ p.address }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Lease Start</label><br>
        <input name="lease_start" type="date" value="{{ tenant.lease.start_date or '' }}">
      </div>
      <div>
        <label>Lease End</label><br>
        <input name="lease_end" type="date" value="{{ tenant.lease.end_date or '' }}">
      </div>
    </div>

    <div>
      <label>Signed Lease (PDF)</label><br>
      <input name="lease_file" type="file" accept="application/pdf">
      {% if tenant.lease and tenant.lease.file_name %}
        <div class="muted" style="margin-top:.25rem;">
          Current:
          <a href="{{ url_for('rental_admin.tenant_lease_view', tenant_id=tenant.tenant_id) }}" target="_blank">
            {{ tenant.lease.file_name }}
          </a>
          |
          <a href="{{ url_for('rental_admin.tenant_lease_download', tenant_id=tenant.tenant_id) }}">
            Download
          </a>
        </div>
      {% endif %}
    </div>

    <div style="display:flex; gap:.75rem;">
      <button type="submit">Save</button>
      <a href="{{ url_for('rental_admin.tenant_list') }}">Back</a>
    </div>
  </form>

  <hr style="margin:1.5rem 0;">

  <!-- ========================= -->
  <!-- Receipt Upload -->
  <!-- ========================= -->
  <h2 style="margin:0 0 .5rem;">Upload Rent Receipt</h2>

  <form method="POST"
        action="{{ url_for('rental_admin.tenant_receipt_upload', tenant_id=tenant.tenant_id) }}"
        enctype="multipart/form-data"
        style="display:grid; gap:.75rem;">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Covered Month (YYYY-MM)</label><br>
        <input name="covered_month" placeholder="2026-02" required>
      </div>
      <div>
        <label>Date Paid</label><br>
        <input name="date_paid" type="date" required>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Amount</label><br>
        <input name="amount" type="number" step="0.01" min="0" required>
      </div>
      <div>
        <label>Payment Method</label><br>
        <select name="payment_method" required>
          <option value="">-- select --</option>
          <option>Check</option>
          <option>Cash</option>
          <option>Zelle</option>
          <option>Venmo</option>
          <option>Bank Transfer</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Status</label><br>
        <select name="status" required>
          <option>Paid in full</option>
          <option>Partial payment</option>
          <option>Late fee included</option>
          <option>Overpayment / credit</option>
          <option>NSF / returned</option>
        </select>
      </div>
      <div>
        <label>Check # (if applicable)</label><br>
        <input name="check_number">
      </div>
    </div>

    <div>
      <label>Receipt File (PDF or image)</label><br>
      <input name="receipt_file" type="file" required>
    </div>

    <div>
      <button type="submit">Upload Receipt</button>
    </div>
  </form>

  <hr style="margin:1.5rem 0;">

  <!-- ========================= -->
  <!-- Lease Coverage Grid -->
  <!-- ========================= -->
  <h2 style="margin:0 0 .5rem;">Lease Coverage</h2>

  {% if lease_months %}
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Month</th>
          <th>Status</th>
          <th>Receipt</th>
        </tr>
      </thead>
      <tbody>
        {% for m in lease_months %}
          {% set r = coverage_map.get(m) %}
          <tr>
            <td>{{ m }}</td>
            <td>
              {% if r %}
                <span class="ok">{{ r.status }}</span>
              {% else %}
                <span class="bad">Not paid</span>
              {% endif %}
            </td>
            <td>
              {% if r %}
                <a href="{{ url_for('rental_admin.receipt_view', receipt_id=r.receipt_id) }}" target="_blank">View</a>
                |
                <a href="{{ url_for('rental_admin.receipt_download', receipt_id=r.receipt_id) }}">Download</a>
              {% else %}
                â€”
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">Set lease start and end dates to see coverage.</p>
  {% endif %}

  <hr style="margin:1.5rem 0;">

  <!-- ========================= -->
  <!-- Receipt List -->
  <!-- ========================= -->
  <h2 style="margin:0 0 .5rem;">All Receipts</h2>

  {% if tenant_receipts %}
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Covered Month</th>
          <th>Amount</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for rid, r in tenant_receipts.items() %}
          <tr>
            <td>{{ r.covered_month }}</td>
            <td>${{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.status }}</td>
            <td>
              <a href="{{ url_for('rental_admin.receipt_view', receipt_id=r.receipt_id) }}" target="_blank">View</a>
              |
              <a href="{{ url_for('rental_admin.receipt_download', receipt_id=r.receipt_id) }}">Download</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No receipts uploaded yet.</p>
  {% endif %}

</div>
{% endblock %}

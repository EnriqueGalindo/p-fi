{% extends "base_rental.html" %}
{% block content %}
<div class="card" style="max-width:900px;">
  <h1 style="margin-top:0;">Edit Tenant</h1>

  <!-- ========================= -->
  <!-- Tenant Info Form -->
  <!-- ========================= -->
  <form method="POST" enctype="multipart/form-data" style="display:grid; gap:.75rem;">
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>First Name</label><br>
        <input name="first_name" value="{{ tenant.first_name }}" required>
      </div>
      <div>
        <label>Last Name</label><br>
        <input name="last_name" value="{{ tenant.last_name }}" required>
      </div>
    </div>

    <div>
      <label>Property</label><br>
      <select name="property_id" required>
        {% for pid, p in properties.items() %}
          <option value="{{ pid }}" {{ "selected" if tenant.property_id==pid else "" }}>
            {{ p.address }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Lease Start</label><br>
        <input name="lease_start" type="date" value="{{ tenant.lease.start_date or '' }}">
      </div>
      <div>
        <label>Lease End</label><br>
        <input name="lease_end" type="date" value="{{ tenant.lease.end_date or '' }}">
      </div>
    </div>

    <div>
      <label>Signed Lease (PDF)</label><br>
      <input name="lease_file" type="file" accept="application/pdf">
      {% if tenant.lease and tenant.lease.file_name %}
        <div class="muted" style="margin-top:.25rem;">
          Current:
          <a href="{{ url_for('rental_admin.tenant_lease_view', tenant_id=tenant.tenant_id) }}" target="_blank">
            {{ tenant.lease.file_name }}
          </a>
          |
          <a href="{{ url_for('rental_admin.tenant_lease_download', tenant_id=tenant.tenant_id) }}">
            Download
          </a>
        </div>
      {% endif %}
    </div>

    <div style="display:flex; gap:.75rem;">
      <button type="submit">Save</button>
      <a href="{{ url_for('rental_admin.tenant_list') }}">Back</a>
    </div>
  </form>

  <hr style="margin:1.5rem 0;">

  <!-- ========================= -->
  <!-- Receipt Upload -->
  <!-- ========================= -->
  <h2 style="margin:0 0 .5rem;">Upload Rent Receipt</h2>

  <form method="POST"
        action="{{ url_for('rental_admin.tenant_receipt_upload', tenant_id=tenant.tenant_id) }}"
        enctype="multipart/form-data"
        style="display:grid; gap:.75rem;">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Covered Month (YYYY-MM)</label><br>
        <input name="covered_month" placeholder="2026-02" required>
      </div>
      <div>
        <label>Date Paid</label><br>
        <input name="date_paid" type="date" required>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Amount</label><br>
        <input name="amount" type="number" step="0.01" min="0" required>
      </div>
      <div>
        <label>Payment Method</label><br>
        <select name="payment_method" required>
          <option value="">-- select --</option>
          <option>Check</option>
          <option>Cash</option>
          <option>Zelle</option>
          <option>Venmo</option>
          <option>Bank Transfer</option>
          <option>Other</option>
        </select>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.75rem;">
      <div>
        <label>Status</label><br>
        <select name="status" required>
          <option>Paid in full</option>
          <option>Partial payment</option>
          <option>Late fee included</option>
          <option>Overpayment / credit</option>
          <option>NSF / returned</option>
        </select>
      </div>
      <div>
        <label>Check # (if applicable)</label><br>
        <input name="check_number">
      </div>
    </div>

    <div>
      <label>Receipt File (PDF or image)</label><br>
      <input name="receipt_file" type="file" required>
    </div>

    <div>
      <button type="submit">Upload Receipt</button>
    </div>
  </form>

  <hr style="margin:1.5rem 0;">

  <!-- ========================= -->
  <!-- Lease Coverage Grid -->
  <!-- ========================= -->
    <h2 style="margin-top:1.25rem;">Lease Coverage</h2>
    <p class="muted" style="margin-top:.25rem;">
    One square per month. Hover for details. Click a paid month to open the receipt.
    </p>

    <style>
    .gh-grid { display:flex; flex-direction:column; gap:.75rem; }
    .gh-row { display:flex; align-items:center; gap:.75rem; }
    .gh-year { width:52px; font-weight:700; color:#374151; }
    .gh-months { display:grid; grid-template-columns: repeat(12, 14px); gap:6px; align-items:center; }
    .gh-cell {
        width:14px; height:14px; border-radius:3px;
        background:#e5e7eb; border:1px solid #e5e7eb;
        display:inline-block;
        position:relative;
    }
    .gh-cell.paid { background:#16a34a; border-color:#16a34a; }
    .gh-cell.partial { background:#d97706; border-color:#d97706; } /* if you later add partials */
    .gh-cell.nsf { background:#dc2626; border-color:#dc2626; }     /* if you later add nsf */
    .gh-cell:hover { outline:2px solid rgba(17,24,39,.25); outline-offset:2px; }

    .gh-tip {
        display:none;
        position:absolute;
        left:50%; transform:translateX(-50%);
        bottom:22px;
        white-space:nowrap;
        background:#111827; color:white;
        padding:6px 8px; border-radius:8px;
        font-size:12px;
        box-shadow:0 8px 20px rgba(0,0,0,.2);
        z-index:10;
    }
    .gh-tip:after{
        content:"";
        position:absolute; left:50%; transform:translateX(-50%);
        top:100%;
        border:6px solid transparent;
        border-top-color:#111827;
    }
    .gh-cell:hover .gh-tip { display:block; }

    .gh-legend { display:flex; align-items:center; gap:.5rem; justify-content:flex-end; margin-top:.5rem; }
    .gh-legend span { font-size:12px; color:#6b7280; }
    .gh-dot { width:12px; height:12px; border-radius:3px; display:inline-block; }
    </style>

    {% if coverage_grid and coverage_grid|length > 0 %}
    {# group into years in-template #}
    {% set rows = {} %}
    {% for c in coverage_grid %}
        {% set year = c.ym.split('-')[0] %}
        {% if year not in rows %}{% set _ = rows.update({year: []}) %}{% endif %}
        {% set _ = rows[year].append(c) %}
    {% endfor %}

    <div class="gh-grid">
        {% for year, months in rows.items()|sort %}
        <div class="gh-row">
            <div class="gh-year">{{ year }}</div>

            <div class="gh-months">
            {# ensure Jan..Dec ordering even if lease starts mid-year #}
            {% for m in range(1, 13) %}
                {% set mm = "%02d"|format(m) %}
                {% set ym = year ~ "-" ~ mm %}
                {% set cell = (months | selectattr("ym","equalto",ym) | list | first) %}
                {% if cell %}
                {% if cell.paid %}
                    <a class="gh-cell paid"
                    href="{{ url_for('rental_admin.receipt_detail', receipt_id=cell.receipt_id) }}">
                    <span class="gh-tip">
                        {{ cell.label }} — {{ cell.status }}
                        {% if cell.date_paid %} · Paid {{ cell.date_paid }}{% endif %}
                        {% if cell.amount is not none %} · ${{ "%.2f"|format(cell.amount) }}{% endif %}
                    </span>
                    </a>
                {% else %}
                    <span class="gh-cell">
                    <span class="gh-tip">{{ cell.label }} — Not paid</span>
                    </span>
                {% endif %}
                {% else %}
                {# month outside lease range: render invisible spacer #}
                <span style="width:14px; height:14px;"></span>
                {% endif %}
            {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="gh-legend">
        <span>Unpaid</span>
        <i class="gh-dot" style="background:#e5e7eb;"></i>
        <i class="gh-dot" style="background:#16a34a;"></i>
        <span>Covered</span>
    </div>

    {% else %}
    <p class="muted">Set lease start and end dates to see coverage.</p>
    {% endif %}


  <!-- ========================= -->
  <!-- Receipt List -->
  <!-- ========================= -->
  <h2 style="margin:0 0 .5rem;">All Receipts</h2>

  {% if tenant_receipts %}
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Covered Month</th>
          <th>Amount</th>
          <th>Status</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for rid, r in tenant_receipts.items() %}
          <tr>
            <td>{{ r.covered_month }}</td>
            <td>${{ "%.2f"|format(r.amount) }}</td>
            <td>{{ r.status }}</td>
            <td>
              <a href="{{ url_for('rental_admin.receipt_view', receipt_id=r.receipt_id) }}" target="_blank">View</a>
              |
              <a href="{{ url_for('rental_admin.receipt_download', receipt_id=r.receipt_id) }}">Download</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="muted">No receipts uploaded yet.</p>
  {% endif %}

</div>
{% endblock %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Tenant portal — gmoney rentals</title>

    {% include "rental_tenant/_theme.html" %}
  </head>

  <body>
    <div class="shell">

      <!-- MAIN -->
      <section class="panel">
        <div class="brand">
          <img src="{{ url_for('static', filename='img/logo.jpeg') }}" alt="gmoney logo">
          <div>
            <div class="title">gmoney rentals</div>
            <div class="subtitle">Receipts • Lease coverage • Payments</div>
          </div>
        </div>

        <div class="stack">

          <div class="card">
  <h1>Tenant portal</h1>

    <!-- KPI grid -->
    <div style="
        margin-top:12px;
        display:grid;
        grid-template-columns: 1fr auto;
        column-gap:40px;
        row-gap:4px;
        align-items:end;
    ">

        <!-- LEFT: next payment -->
        <div class="label">Next payment due on</div>
        <div class="label" style="text-align:right;">Tenant</div>

        <div class="value">
            {{ next_payment_due.strftime("%b %d, %Y") if next_payment_due else "—" }}
        </div>

        <!-- RIGHT: tenant name -->
        <div class="value" style="
            text-align:right;
            font-size:18px;
            font-weight:700;
            color:var(--muted);
        ">
            {{ tenant.first_name }} {{ tenant.last_name }}
        </div>
    </div>

    <!-- CTA -->
    <form method="POST" action="{{ url_for('rental_tenant.create_checkout_session') }}" style="margin-top:18px;">
        <button class="btn" type="submit">Make a payment</button>
    </form>

    <p class="lead muted" style="margin-top:.5rem;">
        You’ll be redirected to Stripe to complete your payment.
    </p>
    </div>


          <div class="card">
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div>
                <div class="label">Property</div>
                <div style="font-weight:900; margin-top:4px;">
                  {% set prop = properties.get(tenant.property_id) %}
                  {{ prop.address if prop else "—" }}
                </div>
              </div>
              <div>
                <div class="label">Lease</div>
                <div style="margin-top:4px; color:var(--muted); font-weight:700;">
                  {{ tenant.lease.start_date or "—" }} → {{ tenant.lease.end_date or "—" }}
                </div>
              </div>
              <div>
                <div class="label">Signed lease</div>
                <div style="margin-top:4px;">
                  {% if tenant.lease and tenant.lease.file_name %}
                    <a href="{{ url_for('rental_tenant.lease_view') }}" target="_blank">
                      View
                    </a>
                    &nbsp;•&nbsp;
                    <a href="{{ url_for('rental_tenant.lease_download') }}">
                      Download
                    </a>
                  {% else %}
                    <span style="color:var(--muted); font-weight:700;">Not on file</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
            <div>
            <div style="font-weight:900; font-size:18px;">Lease coverage</div>
            <div style="color:var(--muted); font-size:13px; margin-top:6px;">
                One square per month. Hover for details. Click a paid month to open the receipt.
            </div>
            </div>
        </div>

        {% if coverage_grid and coverage_grid|length > 0 %}
            {% set rows = {} %}
            {% for c in coverage_grid %}
            {% set year = c.ym.split('-')[0] %}
            {% if year not in rows %}{% set _ = rows.update({year: []}) %}{% endif %}
            {% set _ = rows[year].append(c) %}
            {% endfor %}

            <div class="gh-grid" style="margin-top:14px;">
            {% for year, months in rows.items()|sort %}
                <div class="gh-row">
                <div class="gh-year">{{ year }}</div>
                <div class="gh-months">
                    {% for m in range(1, 13) %}
                    {% set mm = "%02d"|format(m) %}
                    {% set ym = year ~ "-" ~ mm %}
                    {% set cell = (months | selectattr("ym","equalto",ym) | list | first) %}

                    {% if cell %}
                        {% if cell.paid %}
                        {% set klass = "paid" %}
                        {% if cell.status and "partial" in (cell.status|lower) %}
                            {% set klass = "partial" %}
                        {% endif %}

                        <a class="gh-cell {{ klass }}"
                            href="{{ url_for('rental_tenant.receipt_view', receipt_id=cell.receipt_id) }}"
                            target="_blank">
                            <span class="gh-tip">
                            {{ cell.label }} — {{ cell.status }}
                            {% if cell.date_paid %} · Paid {{ cell.date_paid }}{% endif %}
                            {% if cell.amount is not none %} · ${{ "%.2f"|format(cell.amount) }}{% endif %}
                            </span>
                        </a>
                        {% else %}
                        <span class="gh-cell">
                            <span class="gh-tip">{{ cell.label }} — Not paid</span>
                        </span>
                        {% endif %}
                    {% else %}
                        <!-- month not in lease range for this year -->
                        <span style="width:14px; height:14px;"></span>
                    {% endif %}
                    {% endfor %}
                </div>
                </div>
            {% endfor %}
            </div>

            <div class="gh-legend">
            <i class="gh-dot" style="background: rgba(255,255,255,.10);"></i>
            <span>Unpaid</span>

            <i class="gh-dot" style="background: var(--partial);"></i>
            <span>Partial</span>

            <i class="gh-dot" style="background: rgba(34,197,94,.9);"></i>
            <span>Covered</span>
            </div>
        {% else %}
            <p style="color:var(--muted); margin:12px 0 0;">No lease coverage available.</p>
        {% endif %}
        </div>

          <div class="card">
            <div style="font-weight:900; font-size:18px; margin-bottom:10px;">All receipts</div>

            {% if tenant_receipts %}
              <table>
                <thead>
                  <tr>
                    <th>Covered Month</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                    {% for rid, r in tenant_receipts.items() %}
                        {% set receipt_id = r.receipt_id or rid %}
                        <tr>
                        <td>{{ r.covered_month }}</td>
                        <td>${{ "%.2f"|format(r.amount) }}</td>
                        <td>{{ r.status }}</td>
                        <td style="text-align:right;">
                            <a href="{{ url_for('rental_tenant.receipt_view', receipt_id=receipt_id) }}" target="_blank">View</a>
                            &nbsp;|&nbsp;
                            <a href="{{ url_for('rental_tenant.receipt_download', receipt_id=receipt_id) }}">Download</a>
                        </td>
                        </tr>
                    {% endfor %}
                </tbody>

              </table>
            {% else %}
              <p style="color:var(--muted); margin:0;">No receipts uploaded yet.</p>
            {% endif %}
          </div>

        </div>
      </section>
    </div>
  </body>
</html>

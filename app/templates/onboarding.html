{% extends "base.html" %}
{% block content %}
<style>
  .group{border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0}
  .muted{color:#6b7280}
  input,select,textarea{padding:.45rem .6rem;border:1px solid #d1d5db;border-radius:8px}
  button.add{margin-top:.5rem}

  /* rows + action column (trash) */
  .row{display:grid;gap:.5rem;margin:.5rem 0;align-items:center}
  .row.incomes  {grid-template-columns:2fr 1fr 1fr 1fr 40px;}
  .row.costs    {grid-template-columns:2fr 1fr 1fr 1fr 1fr 40px;}
  .row.debts    {grid-template-columns:2fr 1fr 1fr 1fr .8fr 40px;}
  .row.accounts {grid-template-columns:2fr 1fr 1fr 40px;}

  .trash{
    border:1px solid #e5e7eb;background:#fff;border-radius:8px;
    padding:.4rem .55rem;cursor:pointer;line-height:1
  }
  .trash:hover{background:#f9fafb}
</style>

<div class="card">
  <h1>Starting Finances Questionnaire</h1>
  <form method="post" action="/onboarding">

    <!-- Basics -->
    <div class="group">
      <div>
        <label>Currency
          <select name="currency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </select>
        </label>
      </div>
      <div style="margin-top:.5rem;">
        <label>Household size
          <input name="household_size" type="number" min="1" value="1"/>
        </label>
      </div>
      <div style="margin-top:.75rem;">
        <label><input type="checkbox" name="has_employer_plan"> I have an employer plan with matching</label>
        <div class="muted">If yes, fill these (optional):</div>
        <input name="employer_match_pct_on_salary" placeholder="Match cap % of salary (e.g., 6)"/>
        <input name="employer_match_rate" placeholder="Match rate % (e.g., 50)"/>
      </div>
    </div>

    <!-- Incomes -->
    <div class="group" id="incomes">
      <h3>Incomes â€” recurring sources of income</h3>
      <div class="rows" data-group="incomes">
        <div class="row incomes template" hidden>
          <input name="incomes-name[]" placeholder="Name (e.g., Salary)"/>
          <input name="incomes-amount[]" placeholder="Amount (e.g., 3500)"/>
          <select name="incomes-interval[]">
            <option value="monthly">monthly</option>
            <option value="biweekly">biweekly</option>
            <option value="weekly">weekly</option>
            <option value="annual">annual</option>
          </select>
          <select name="incomes-after_tax[]">
            <option value="true">after-tax</option>
            <option value="false">pre-tax</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('incomes')">+ Add income</button>
    </div>

    <!-- Costs -->
    <div class="group" id="costs">
      <h3>Costs â€” recurring expenses</h3>
      <div class="rows" data-group="costs">
        <div class="row costs template" hidden>
          <input name="costs-name[]" placeholder="Name (e.g., Rent)"/>
          <input name="costs-amount[]" placeholder="Amount (e.g., 1200)"/>
          <select name="costs-interval[]">
            <option value="monthly">monthly</option>
            <option value="biweekly">biweekly</option>
            <option value="weekly">weekly</option>
            <option value="annual">annual</option>
          </select>
          <select name="costs-type[]">
            <option value="">-- type --</option>
            <option value="health_fitness">health/fitness</option>
            <option value="grocery">grocery</option>
            <option value="entertainment">entertainment</option>
            <option value="utility">utility</option>
            <option value="pet">pet</option>
            <option value="clothes">clothes</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('costs')">+ Add cost</button>
    </div>

    <!-- Debts -->
    <div class="group" id="debts">
      <h3>Debts â€” outstanding debts</h3>
      <div class="rows" data-group="debts">
        <div class="row debts template" hidden>
          <input name="debts-name[]" placeholder="Name (e.g., Visa)"/>
          <input name="debts-balance[]" placeholder="Balance (e.g., 2300)"/>
          <input name="debts-apr[]" placeholder="APR % (e.g., 24.99)"/>
          <input name="debts-min_payment[]" placeholder="Min payment (e.g., 75)"/>
          <input name="debts-due_day[]" placeholder="Due day (1-31)"/>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('debts')">+ Add debt</button>
    </div>

    <!-- Accounts -->
    <div class="group" id="accounts">
      <h3>Accounts â€” bank/asset balances</h3>
      <div class="rows" data-group="accounts">
        <div class="row accounts template" hidden>
          <input name="accounts-name[]" placeholder="Name (e.g., Checking)"/>
          <input name="accounts-balance[]" placeholder="Balance (e.g., 2500)"/>
          <select name="accounts-type[]" required>
            <option value="" selected disabled>-- type --</option>
            <option value="cash">cash</option>
            <option value="checking">checking</option>
            <option value="savings">savings</option>
            <option value="investment">investment</option>
            <option value="retirement">retirement</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('accounts')">+ Add account</button>
    </div>

    <!-- Notes -->
    <div class="group">
      <label>Notes</label><br/>
      <textarea name="notes" rows="3" style="width:100%"></textarea>
    </div>

    <button type="submit">Save snapshot</button>
  </form>
</div>

<script>
  // Add a row by cloning the group's hidden template
  function addRow(sectionId){
    const section = document.querySelector('#'+sectionId+' .rows');
    const tpl = section.querySelector('.template');
    const clone = tpl.cloneNode(true);
    clone.hidden = false;
    clone.classList.remove('template');
    section.appendChild(clone);
    return clone;
  }

  // Remove a row; only auto-add a blank if the group would be empty
  function removeRow(evt, btn){
    if (evt) evt.preventDefault();
    const row = btn.closest('.row');
    if (!row || row.classList.contains('template')) return;
    row.remove(); // no auto-add when empty
  }

  // Prefill from server JSON (profile)
  (function(){
    const initial = {{ (profile or {})|tojson|safe }};

    // top-level
    if(initial.currency) document.querySelector('[name="currency"]').value = initial.currency;
    if(initial.household_size) document.querySelector('[name="household_size"]').value = initial.household_size;
    if(initial.has_employer_plan) document.querySelector('[name="has_employer_plan"]').checked = true;
    if(initial.employer_match_pct_on_salary) document.querySelector('[name="employer_match_pct_on_salary"]').value = initial.employer_match_pct_on_salary;
    if(initial.employer_match_rate) document.querySelector('[name="employer_match_rate"]').value = initial.employer_match_rate;
    if(initial.notes) document.querySelector('[name="notes"]').value = initial.notes;

    function seedArray(sectionId, items, fill){
      const rows = document.querySelector('#'+sectionId+' .rows');
      rows.querySelectorAll(':scope > .row:not(.template)').forEach(n=>n.remove());
      if(items && items.length){
        items.forEach(obj=>{
          const r = addRow(sectionId);
          fill(r, obj);
        });
      } else {
        // start with one blank row for usability
        addRow(sectionId);
      }
    }

    seedArray('incomes',  initial.income_streams, (row, inc)=>{
      row.querySelector('[name="incomes-name[]"]').value   = inc.name || '';
      row.querySelector('[name="incomes-amount[]"]').value = inc.amount ?? '';
      row.querySelector('[name="incomes-interval[]"]').value = (inc.interval || 'monthly');
      row.querySelector('[name="incomes-after_tax[]"]').value = (inc.after_tax ? 'true' : 'false');
    });

    seedArray('costs', initial.recurring_costs, (row, c)=>{
      row.querySelector('[name="costs-name[]"]').value   = c.name || '';
      row.querySelector('[name="costs-amount[]"]').value = c.amount ?? '';
      row.querySelector('[name="costs-interval[]"]').value = (c.interval || 'monthly');
      row.querySelector('[name="costs-type[]"]').value = (c.type || '');
    });

    seedArray('debts', initial.debts, (row, d)=>{
      row.querySelector('[name="debts-name[]"]').value = d.name || '';
      row.querySelector('[name="debts-balance[]"]').value = d.balance ?? '';
      row.querySelector('[name="debts-apr[]"]').value = d.apr ?? '';
      row.querySelector('[name="debts-min_payment[]"]').value = d.min_payment ?? '';
      row.querySelector('[name="debts-due_day[]"]').value = d.due_day ?? '';
    });

    seedArray('accounts', initial.accounts, (row, a)=>{
      row.querySelector('[name="accounts-name[]"]').value = a.name || '';
      row.querySelector('[name="accounts-balance[]"]').value = a.balance ?? '';
      row.querySelector('[name="accounts-type[]"]').value = (a.type || '').toLowerCase();
    });
  })();
</script>
{% endblock %}

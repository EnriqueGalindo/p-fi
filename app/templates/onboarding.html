{% extends "base.html" %}
{% block content %}
<style>
  .group{border:1px solid #e5e7eb;border-radius:12px;padding:1rem;margin:1rem 0}
  .muted{color:#6b7280}
  input,select,textarea{padding:.45rem .6rem;border:1px solid #d1d5db;border-radius:8px}
  button.add{margin-top:.5rem}

  /* rows + action column (trash) */
  .row{display:grid;gap:.5rem;margin:.5rem 0;align-items:center}
  .row.incomes  {grid-template-columns:2fr 1fr 1fr 1fr 40px;}
  .row.costs    {grid-template-columns:2fr 1fr 1fr 1fr 1fr 40px;}
  /* name, bal, apr, min, due_day, type, trash */
  .row.debts    {grid-template-columns:2fr 1fr 1fr 1fr .7fr 1fr 40px;}
  .row.accounts {grid-template-columns:2fr 1fr 1fr 40px;}

  .trash{
    border:1px solid #e5e7eb;background:#fff;border-radius:8px;
    padding:.4rem .55rem;cursor:pointer;line-height:1
  }
  .trash:hover{background:#f9fafb}
</style>

<div class="card">
  <h1>Starting Finances Questionnaire</h1>
  <form method="post" action="/onboarding">

    <!-- Basics -->
    <div class="group">
      <div>
        <label>Currency
          <select name="currency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </select>
        </label>
      </div>
      <div style="margin-top:.5rem;">
        <label>Household size
          <input name="household_size" type="number" min="1" value="1"/>
        </label>
      </div>
      <div style="margin-top:.75rem;">
        <label><input type="checkbox" name="has_employer_plan"> I have an employer plan with matching</label>
        <div class="muted">If yes, fill these (optional):</div>
        <input name="employer_match_pct_on_salary" placeholder="Match cap % of salary (e.g., 6)"/>
        <input name="employer_match_rate" placeholder="Match rate % (e.g., 50)"/>
      </div>
    </div>

    <!-- Incomes -->
    <div class="group" id="incomes">
      <h3>Incomes â€” recurring sources of income</h3>
      <div class="rows" data-group="incomes">
        <div class="row incomes template" hidden>
          <input name="incomes-name[]" placeholder="Name (e.g., Salary)"/>
          <input name="incomes-amount[]" placeholder="Amount (e.g., 3500)"/>
          <select name="incomes-interval[]">
            <option value="monthly">monthly</option>
            <option value="biweekly">biweekly</option>
            <option value="weekly">weekly</option>
            <option value="annual">annual</option>
          </select>
          <select name="incomes-after_tax[]">
            <option value="true">after-tax</option>
            <option value="false">pre-tax</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('incomes')">+ Add income</button>
    </div>

    <!-- Costs -->
    <div class="group" id="costs">
      <h3>Costs â€” recurring expenses</h3>
      <div class="rows" data-group="costs">
        <div class="row costs template" hidden>
          <input name="costs-name[]" placeholder="Name (e.g., Rent)"/>
          <input name="costs-amount[]" placeholder="Amount (e.g., 1200)"/>
          <select name="costs-interval[]">
            <option value="monthly">monthly</option>
            <option value="biweekly">biweekly</option>
            <option value="weekly">weekly</option>
            <option value="annual">annual</option>
          </select>
          <select name="costs-type[]">
            <option value="">-- type --</option>
            <option value="health_fitness">health/fitness</option>
            <option value="grocery">grocery</option>
            <option value="entertainment">entertainment</option>
            <option value="utility">utility</option>
            <option value="pet">pet</option>
            <option value="clothes">clothes</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('costs')">+ Add cost</button>
    </div>

    <!-- Debts -->
    <div class="group" id="debts">
      <h3>Debts â€” outstanding debts</h3>
      <div class="rows" data-group="debts">
        <div class="row debts template" hidden>
          <input name="debts-name[]" placeholder="Name (e.g., Visa or Mortgage)"/>
          <input name="debts-balance[]" placeholder="Balance (e.g., 2300)"/>
          <input name="debts-apr[]" placeholder="APR % (e.g., 24.99)"/>
          <input name="debts-min_payment[]" placeholder="Min payment (e.g., 75)"/>
          <input name="debts-due_day[]" placeholder="Due day (1-31)"/>

          <!-- Type -->
          <select name="debts-type[]" class="debt-type">
            <option value="revolving" selected>revolving</option>
            <option value="mortgage">mortgage</option>
            <option value="other">other</option>
          </select>

          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>

          <!-- Mortgage-only fields (full width) -->
          <div class="mortgage-extra" style="display:none; grid-column: 1 / -1;">
            <div class="row" style="grid-template-columns: repeat(3, 1fr);">
              <input name="debts-escrow[]" placeholder="Escrow portion /mo (e.g., 400)"/>
              <input name="debts-interest_portion[]" placeholder="Interest portion /mo (e.g., 950)"/>
              <input name="debts-principal_portion[]" placeholder="Principal portion /mo (e.g., 650)"/>
            </div>
            <div class="muted" style="margin-top:.25rem;">
              Tip: enter your latest statementâ€™s split. Weâ€™ll use it to improve payoff estimates.
            </div>
          </div>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('debts')">+ Add debt</button>
    </div>

    <!-- Accounts -->
    <div class="group" id="accounts">
      <h3>Accounts â€” bank/asset balances</h3>
      <div class="rows" data-group="accounts">
        <div class="row accounts template" hidden>
          <input name="accounts-name[]" placeholder="Name (e.g., Checking)"/>
          <input name="accounts-balance[]" placeholder="Balance (e.g., 2500)"/>
          <select name="accounts-type[]" required>
            <option value="" selected disabled>-- type --</option>
            <option value="cash">cash</option>
            <option value="checking">checking</option>
            <option value="savings">savings</option>
            <option value="investment">investment</option>
            <option value="retirement">retirement</option>
          </select>
          <button type="button" class="trash" aria-label="Remove row" onclick="removeRow(event, this)">ðŸ—‘</button>
        </div>
      </div>
      <button type="button" class="add" onclick="addRow('accounts')">+ Add account</button>
    </div>

    <!-- Notes -->
    <div class="group">
      <label>Notes</label><br/>
      <textarea name="notes" rows="3" style="width:100%"></textarea>
    </div>

    <button type="submit">Save snapshot</button>
  </form>
</div>

<script>
  // --- helpers ---
  function addRow(sectionId){
    const section = document.querySelector('#'+sectionId+' .rows');
    const tpl = section.querySelector('.template');
    const clone = tpl.cloneNode(true);
    clone.hidden = false;
    clone.classList.remove('template');
    section.appendChild(clone);
    // Wire debt toggles when adding debt rows
    if (sectionId === 'debts') wireDebtRow(clone);
    return clone;
  }

  function removeRow(evt, btn){
    if (evt) evt.preventDefault();
    const row = btn.closest('.row');
    if (!row || row.classList.contains('template')) return;
    row.remove();
  }

  function wireDebtRow(row){
    const typeSel = row.querySelector('.debt-type');
    const extra   = row.querySelector('.mortgage-extra');
    const toggle = () => { if (extra) extra.style.display = (typeSel?.value === 'mortgage') ? '' : 'none'; };
    if (typeSel) typeSel.addEventListener('change', toggle);
    toggle();
  }

  function seedArray(sectionId, items, fill){
    const rows = document.querySelector('#'+sectionId+' .rows');
    rows.querySelectorAll(':scope > .row:not(.template)').forEach(n=>n.remove());
    if(items && items.length){
      items.forEach(obj=>{
        const r = addRow(sectionId);
        fill(r, obj);
      });
    } else {
      addRow(sectionId); // one blank row for usability
    }
  }

  // --- preload from server JSON ---
  (function(){
    const initial = {{ (profile or {})|tojson|safe }};

    // top-level
    if(initial.currency) document.querySelector('[name="currency"]').value = initial.currency;
    if(initial.household_size) document.querySelector('[name="household_size"]').value = initial.household_size;
    if(initial.has_employer_plan) document.querySelector('[name="has_employer_plan"]').checked = true;
    if(initial.employer_match_pct_on_salary) document.querySelector('[name="employer_match_pct_on_salary"]').value = initial.employer_match_pct_on_salary;
    if(initial.employer_match_rate) document.querySelector('[name="employer_match_rate"]').value = initial.employer_match_rate;
    if(initial.notes) document.querySelector('[name="notes"]').value = initial.notes;

    // incomes
    seedArray('incomes',  initial.income_streams, (row, inc)=>{
      row.querySelector('[name="incomes-name[]"]').value   = inc.name || '';
      row.querySelector('[name="incomes-amount[]"]').value = inc.amount ?? '';
      row.querySelector('[name="incomes-interval[]"]').value = (inc.interval || 'monthly');
      row.querySelector('[name="incomes-after_tax[]"]').value = (inc.after_tax ? 'true' : 'false');
    });

    // costs
    seedArray('costs', initial.recurring_costs, (row, c)=>{
      row.querySelector('[name="costs-name[]"]').value   = c.name || '';
      row.querySelector('[name="costs-amount[]"]').value = c.amount ?? '';
      row.querySelector('[name="costs-interval[]"]').value = (c.interval || 'monthly');
      row.querySelector('[name="costs-type[]"]').value = (c.type || '');
    });

    // debts (type + mortgage extras)
    seedArray('debts', initial.debts, (row, d)=>{
      const set = (sel, val) => { const el = row.querySelector(sel); if (el) el.value = (val ?? ''); };

      set('[name="debts-name[]"]', d.name);
      set('[name="debts-balance[]"]', d.balance);
      set('[name="debts-apr[]"]', d.apr);
      set('[name="debts-min_payment[]"]', d.min_payment);
      set('[name="debts-due_day[]"]', d.due_day);

      const type = (d.type || 'revolving').toLowerCase();
      set('[name="debts-type[]"]', type);
      wireDebtRow(row); // show mortgage block if needed

      if (type === 'mortgage') {
        set('[name="debts-escrow[]"]', d.escrow);
        set('[name="debts-interest_portion[]"]', d.interest_portion);
        set('[name="debts-principal_portion[]"]', d.principal_portion);
      }
    });

    // accounts
    seedArray('accounts', initial.accounts, (row, a)=>{
      row.querySelector('[name="accounts-name[]"]').value = a.name || '';
      row.querySelector('[name="accounts-balance[]"]').value = a.balance ?? '';
      row.querySelector('[name="accounts-type[]"]').value = (a.type || '').toLowerCase();
    });
  })();
</script>
{% endblock %}
